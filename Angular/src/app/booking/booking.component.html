<div class="booking-page">
  <div class="card">
    <button class="back" (click)="goBack()">← Back</button>

    <div *ngIf="doctor; else searchView">
      <div class="doctor-head">
        <div class="avatar">{{ getInitials(doctor.name) }}</div>
        <div class="meta">
          <h2>{{ doctor.name }}</h2>
          <p class="muted">{{ doctor.specialty }} • {{ doctor.clinic || '' }}</p>
        </div>
      </div>

      <div class="section">
        <label>Select Date</label>
        <input type="date"
               [(ngModel)]="selectedDate"
               (ngModelChange)="loadAvailableTimes()" />
      </div>

      <div class="section">
        <label>Pick Day</label>
        <div class="weekday-row">
          <button type="button"
                  class="chip"
                  *ngFor="let d of weekdayLabels; let i = index"
                  [class.active]="selectedWeekday === weekdayOrder[i]"
                  (click)="pickWeekday(weekdayOrder[i])">
            {{ d }}
          </button>
        </div>
      </div>

      <!-- ✅ FIXED HERE -->
      <div class="section">
        <label>Period</label>
        <div class="period-row">
          <button type="button" class="chip"
                  [class.active]="selectedPeriod==='all'"
                  (click)="selectedPeriod='all'; filterTimesBySelection()">All</button>

          <button type="button" class="chip"
                  [class.active]="selectedPeriod==='morning'"
                  (click)="selectedPeriod='morning'; filterTimesBySelection()">Morning</button>

          <button type="button" class="chip"
                  [class.active]="selectedPeriod==='afternoon'"
                  (click)="selectedPeriod='afternoon'; filterTimesBySelection()">Afternoon</button>

          <button type="button" class="chip"
                  [class.active]="selectedPeriod==='evening'"
                  (click)="selectedPeriod='evening'; filterTimesBySelection()">Evening</button>

          <button type="button" class="chip"
                  [class.active]="selectedPeriod==='night'"
                  (click)="selectedPeriod='night'; filterTimesBySelection()">Night</button>
        </div>
      </div>
    </div>

    <!-- SEARCH VIEW -->
    <ng-template #searchView>
      <div class="search">
        <h2>Find a Doctor</h2>

        <div class="filters two-row">
          <div class="row">
            <select [(ngModel)]="selectedSpecialty"
                    (ngModelChange)="computeAvailableTimesForSearch()">
              <option value="all">All Specialties</option>
              <option *ngFor="let s of specialties" [value]="s">{{ s }}</option>
            </select>

            <select [(ngModel)]="selectedCity"
                    (ngModelChange)="computeAvailableTimesForSearch()">
              <option value="all">All Cities</option>
              <option *ngFor="let c of cities" [value]="c">{{ c }}</option>
            </select>
          </div>

          <div class="row">
            <label class="small">Weekday</label>
            <div style="display:flex;gap:6px;flex-wrap:wrap">
              <button type="button"
                      class="chip"
                      *ngFor="let d of weekdayLabels.slice(0,6); let i = index"
                      [class.active]="selectedWeekday===weekdayOrder[i]"
                      (click)="pickWeekday(weekdayOrder[i])">
                {{ d }}
              </button>
            </div>

            <label class="small">Period</label>
            <div style="display:flex;gap:6px;flex-wrap:wrap">
              <button class="chip"
                      [class.active]="selectedPeriod==='morning'"
                      (click)="selectedPeriod='morning'; computeAvailableTimesForSearch()">Morning</button>

              <button class="chip"
                      [class.active]="selectedPeriod==='afternoon'"
                      (click)="selectedPeriod='afternoon'; computeAvailableTimesForSearch()">Afternoon</button>

              <button class="chip"
                      [class.active]="selectedPeriod==='evening'"
                      (click)="selectedPeriod='evening'; computeAvailableTimesForSearch()">Evening</button>

              <button class="chip"
                      [class.active]="selectedPeriod==='all'"
                      (click)="selectedPeriod='all'; computeAvailableTimesForSearch()">All</button>
            </div>

            <div *ngIf="availableSearchTimes?.length" style="margin-top:8px">
              <label class="small">Available times</label>
              <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:6px">
                <button type="button"
                        class="time-pill"
                        *ngFor="let t of availableSearchTimes"
                        (click)="selectTime(t)"
                        [class.active]="selectedTime===t">
                  {{ t }}
                </button>
              </div>
            </div>
          </div>
        </div>

        <div class="results">
          <div *ngFor="let d of paginatedDoctors()" class="result-card">
            <div class="left">
              <div class="avatar-sm">{{ getInitials(d.name) }}</div>
            </div>
            <div class="mid">
              <h3>{{ d.name }}</h3>
              <p class="muted">{{ d.specialty }} • {{ d.location || '—' }}</p>
            </div>
            <div class="right">
              <button class="primary-btn" (click)="selectDoctor(d.id)">Book</button>
            </div>
          </div>

          <div class="pagination" *ngIf="filteredDoctors().length > pageSize">
            <button (click)="prevPage()" [disabled]="pageIndex===0">Previous</button>
            <span class="muted">Page {{ pageIndex + 1 }} / {{ totalPages }}</span>
            <button (click)="nextPage()" [disabled]="pageIndex >= totalPages - 1">Next</button>
          </div>

          <p *ngIf="filteredDoctors().length === 0" class="muted">
            No doctors found for selected criteria.
          </p>
        </div>
      </div>
    </ng-template>
  </div>
</div>
